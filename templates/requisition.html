{% extends 'base.html' %}

{% block head %}{% endblock %}

{% block body %}
<body>
    <div class="dim-overlay"></div>
    <header class="header">
        <div class="menu-logo">
            <div class="menu-icon">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
            <img class="syncore-logo" src="static/images/syncore-main.png" alt="Company Logo">
        </div>
        <div class="user-profile">
            <div class="user-info">
                <p>{{ username }}</p>
                <span>{{ role }}</span>
            </div>            
        </div>
    </header>

    <div class="container">
        <h1>Requisition List</h1>
        <table id="requisition-list">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Date</th>
                    <th>Purpose</th>
                    <th>Billing</th>
                    <th>Shipping</th>
                    <th>Details</th>
                    <th>Status</th>
                    <th>Actions</th> <!-- New column for actions -->
                </tr>
            </thead>
            <tbody>
                {% for requisition in requisitions %}
                <tr data-id="{{ requisition.id }}">
                    <td>{{ requisition.id }}</td>
                    <td>{{ requisition.date }}</td>
                    <td>{{ requisition.purpose }}</td>
                    <td>{{ requisition.billing }}</td>
                    <td>{{ requisition.shipping }}</td>
                    <td><button onclick="viewDetails('{{ requisition.id }}')">View</button></td>
                    <td>{{ requisition.status }}</td>
                    <td>
                        <button onclick="openUpdateModal('{{ requisition.id }}')">Update</button>
                        <button onclick="deleteRequisition('{{ requisition.id }}')">Delete</button>
                    </td> <!-- New buttons for update and delete -->
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button id="manage-button" onclick="openModal()">Manage Requisition</button>
    </div>

    <!-- Modal for managing requisitions -->
    <div id="manage-requisition-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2>Manage Requisition</h2>
            <form id="requisition-form" action="/" method="POST">
                <div class="form-group">
                    <label for="requisition-id">Requisition ID:</label>
                    <span id="requisition-id" name="requisition-id">Auto-generated ID</span>
                </div>
                <div class="form-group">
                    <label for="date">Date:</label>
                    <input type="text" id="date" name="date" readonly> <!-- Automatically added date -->
                </div>
                <div class="form-group">
                    <label for="purpose">Purpose:</label>
                    <input type="text" id="purpose" name="purpose" placeholder="Reason for the requisition" required>
                </div>
                <div class="form-group">
                    <label for="billing">Billing Information:</label>
                    <input type="text" id="billing" name="billing" placeholder="Billing details" required>
                </div>
                <div class="form-group">
                    <label for="shipping">Shipping Information:</label>
                    <input type="text" id="shipping" name="shipping" placeholder="Shipping details" required>
                </div>
                <div class="form-group">
                    <label for="attachments">Attachments:</label>
                    <input type="file" id="attachments" name="attachments" multiple>
                </div>
                <div class="form-group">
                    <label for="items">Items Requested:</label>
                    <textarea id="items" name="items" rows="3" placeholder="List of items" required></textarea>
                </div>
                <div class="form-group">
                    <label for="details">Details (Description, Quantity, Price):</label>
                    <textarea id="details" name="details" rows="5" placeholder="Provide details for each item" required></textarea>
                </div>
                <button type="submit">Submit Requisition</button>
            </form>
        </div>
    </div>

    <!-- Modal for displaying requisition details -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeDetailsModal()">&times;</span>
            <h2>Requisition Details</h2>
            <div id="details-content">
                <!-- Details will be populated here -->
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/requisition.js') }}"></script>
    <script>
        function viewDetails(requisitionId) {
            fetch(`/get_requisition/${requisitionId}`)
            .then(response => {
                if (response.ok) {
                    return response.json(); // Parse JSON response
                }
                throw new Error('Requisition not found');
            })
            .then(requisition => {
                // Populate the details modal with requisition data
                const detailsContent = `
                    <p><strong>ID:</strong> ${requisition.id}</p>
                    <p><strong>Date:</strong> ${requisition.date}</p>
                    <p><strong>Purpose:</strong> ${requisition.purpose}</p>
                    <p><strong>Billing:</strong> ${requisition.billing}</p>
                    <p><strong>Shipping:</strong> ${requisition.shipping}</p>
                    <p><strong>Status:</strong> ${requisition.status}</p>
                `;
                document.getElementById('details-content').innerHTML = detailsContent;
                
                // Open the modal
                document.getElementById('details-modal').style.display = 'block';
            })
            .catch(error => console.error('Error:', error));
        }

        function closeDetailsModal() {
            document.getElementById('details-modal').style.display = 'none'; // Close the details modal
        }
        
        function deleteRequisition(requisitionId) {
            if (confirm('Are you sure you want to delete this requisition?')) {
                fetch(`/delete_requisition/${requisitionId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.status === 204) {
                        // Successfully deleted
                        alert('Requisition deleted successfully.');
                        location.reload(); // Reload the page to see the changes
                    } else {
                        alert('Failed to delete the requisition.');
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }

        function openUpdateModal(requisitionId) {
            // Fetch the requisition details using the requisition ID
            fetch(`/get_requisition/${requisitionId}`)
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Requisition not found');
            })
            .then(requisition => {
                // Populate the modal fields with the requisition data
                document.getElementById('requisition-id').innerText = requisition.id;
                document.getElementById('date').value = requisition.date;
                document.getElementById('purpose').value = requisition.purpose;
                document.getElementById('billing').value = requisition.billing;
                document.getElementById('shipping').value = requisition.shipping;

                // Open the modal
                document.getElementById('manage-requisition-modal').style.display = 'block';
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</body>
{% endblock %}